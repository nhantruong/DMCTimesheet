@model IEnumerable<DMCTimesheet.Models.C01_Projects>
@{
    DMCTimesheet.Models.C06_UserPermisRelationship Userpermiss = Session["UserPermission"] as DMCTimesheet.Models.C06_UserPermisRelationship;

    DMCTimesheet.Models.C02_Members loginUser = Session["UserLogin"] as DMCTimesheet.Models.C02_Members;
    List<DMCTimesheet.Models.C01_Projects> myProject = ViewBag.Projects as List<DMCTimesheet.Models.C01_Projects>;

    List<DMCTimesheet.Models.C13_ProjectType> projectType = ViewBag.ProjectType as List<DMCTimesheet.Models.C13_ProjectType>;
    List<DMCTimesheet.Models.C16_Status> status = ViewBag.Status as List<DMCTimesheet.Models.C16_Status>;
    List<DMCTimesheet.Models.C20_Stage> stage = ViewBag.Stage as List<DMCTimesheet.Models.C20_Stage>;

    List<DMCTimesheet.Models.C11_Location> locations = ViewBag.Location as List<DMCTimesheet.Models.C11_Location>;
    List<DMCTimesheet.Models.C10_Owner> owners = ViewBag.Owner as List<DMCTimesheet.Models.C10_Owner>;
    List<DMCTimesheet.Models.C23_NguonViec> nguonviec = ViewBag.NguonViec as List<DMCTimesheet.Models.C23_NguonViec>;

}

<script src="~/Scripts/bootstrap-table-multiple-sort.min.js"></script>
<link href="~/Content/cscpda-scrollbar.css" rel="stylesheet" />
@* Modal create new *@
<div>
    <p class="text-danger">@ViewBag.Error</p>
</div>
@* Form nhập liệu *@
<div id="newProject" class="modal fade" role="dialog">
    <div class="modal-dialog modal-m">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Thêm dự án mới</h3>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("CreateNewProject", "Project", FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <form>
                        <div class="form-group row text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Năm</lable>
                            <input type="number" class="text-dark form-control col-md-7 col-sm-9 col-xs-9" name="Year" value="@DateTime.Now.Year" />
                        </div>
                        @*MADuAn *@
                        <div class="form-group row text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Mã dự án</lable>
                            <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" name="MaDuAn" placeholder="Nhập Mã dự án" value="" />
                        </div>
                        <div class="form-group row text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-4">Tên dự án (Theo Hợp đồng)</lable>
                            <input type="text" class="form-control col-md-7 col-sm-9 col-xs-8" name="ProjectName" placeholder="" value="" />
                        </div>
                        <div class="form-group row text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên rút gọn</lable>
                            <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" name="ProjectOtherName" placeholder="" required="" value="" />
                        </div>
                        <div class="form-group row">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3 text-left">Ngày bắt đầu</lable>
                            <input type="date" class="form-control col-md-7 col-sm-9 col-xs-9" name="StartDate" placeholder="" required="" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>

                        @* NguonViex *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Nguồn công việc</lable>
                            <select id="NguonViec" name="NguonViec" class="form-control col-md-6 col-sm-9 col-xs-9">
                                <option value="">Chọn</option>
                                @foreach (var item in nguonviec)
                                {
                                    <option value=@item.Id>@item.NguonViec</option>
                                }
                            </select>
                            @* *@
                            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#add">...</button>
                        </div>

                        @* ProjectTypeID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Loại hình dự án</lable>
                            <select id="slprojectType" name="ProjectTypeId" class="form-control col-md-6 col-sm-9 col-xs-9">
                                <option value="">Chọn</option>
                                @foreach (var item in projectType.OrderBy(s => s.TypeName))
                                {
                                    <option value=@item.TypeId>@item.TypeName</option>
                                }
                            </select>
                            @* Nút Thêm Nhanh ProjectType *@
                            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#addPtypeModal">...</button>
                        </div>
                        @* StatusID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tình trạng</lable>
                            <select id="statusId" name="ProjectStatusId" class="form-control col-md-6 col-sm-9 col-xs-9">
                                <option value="">Chọn</option>
                                @foreach (var item in status.OrderBy(s => s.StatusName))
                                {
                                    <option value=@item.Id>@item.StatusName</option>
                                }
                            </select>
                            @* Nút Thêm Nhanh Status *@
                            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#addStatusModal">...</button>
                        </div>
                        @* LocationID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Vị trí</lable>
                            <select id="locationId" name="LocationId" class="form-control col-md-6 col-sm-9 col-xs-9">
                                <option value="">Chọn</option>
                                @foreach (var item in locations.OrderBy(s => s.LocationName))
                                {
                                    <option value=@item.LocationId>@item.LocationName</option>
                                }
                            </select>
                            @* Nút Thêm Nhanh Location *@
                            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#addLocationModal">...</button>
                        </div>
                        @* OwnerID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Chủ đầu tư</lable>
                            <select id="OwnerId" name="OwnerId" class="form-control col-md-6 col-sm-9 col-xs-9">
                                <option value="">Chọn</option>
                                @foreach (var item in owners.OrderBy(s => s.ShortName))
                                {
                                    <option value=@item.OnwerId>@item.ShortName</option>
                                }
                            </select>
                            @* Nút Thêm Nhanh CDT *@
                            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#addOwnerModal">...</button>
                        </div>
                        @* StageID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Giai Đoạn</lable>
                            <select id="ProjectStage" name="ProjectStage" class="form-control col-md-6 col-sm-9 col-xs-9">
                                <option value="">Chọn</option>
                                @foreach (var item in stage.OrderBy(s => s.StageName))
                                {
                                    <option value=@item.Id>@item.StageName</option>
                                }
                            </select>
                            @* Nút Thêm Nhanh CDT *@
                            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#addStageModal">...</button>
                        </div>


                        <div class="form-group text-left">
                            <lable class="control-label col-md-4 col-sm-4 col-xs-3 text-left"></lable>
                            <input type="submit" value="Save" class="btn btn-dark col-md-12" />
                        </div>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

@* sub modal *@
<!-- 1. The Modal PROJECT TYPE-->
<div class="modal" id="addPtypeModal">
    <div class="modal-dialog modal-dialog-centered" style="width: 600px">
        <div class="modal-content text-white" style="background-color:#808080">
            <div class="modal-header">
                <h6 class="modal-title">Thêm loại hình dự án</h6>
            </div>
            <div class="modal-body text-white">
                @Html.AntiForgeryToken()
                <form>
                    @* WorkType *@
                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên loại hình</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="typename" name="TypeName" placeholder="Tên loại hình" required value="" />
                    </div>
                    <div class="form-group row text-left ">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Chú thích</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="typedesc" name="Description" placeholder="Chú thích" value="" />
                    </div>
                    <div class="clearfix"></div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="button" class="close btn btn-dark text-white-50" name="name" value="Lưu" data-dismiss="modal" data-target="#addPtypeModal" onclick="getProjectType()" />
            </div>
        </div>
    </div>
</div>

<!-- 2. The Modal STATUS-->
<div class="modal" id="addStatusModal">
    <div class="modal-dialog modal-dialog-centered" style="width: 600px">
        <div class="modal-dialog modal-dialog-centered" style="width: 600px">
            <div class="modal-content text-white" style="background-color:#808080">
                <div class="modal-header">
                    <h6 class="modal-title">Thêm Tình trạng dự án</h6>
                </div>
                <div class="modal-body text-white">
                    <form>
                        <div class="form-group row text-left">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên Tình trạng dự án</lable>
                            <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="StatusName" name="StatusName" placeholder="Tên" required="" value="" />
                            <span class=""></span>
                        </div>

                        <div class="form-group row text-left inline">
                            <lable class="control-label col-md-3 col-sm-3 col-xs-3">Thay đổi Màu sắc</lable>
                            <select name="ColorCode" class="form-control col-md-7 col-sm-9 col-xs-9" id="ColorCode" onclick="OnchangeColor()">
                                <option id="" value=""></option>
                                <option id="badge badge-primary" value="badge badge-primary" class="p-3 mb-2 bg-primary text-white">blue</option>
                                <option id="badge badge-secondary" value="badge badge-secondary" class="p-3 mb-2 bg-secondary text-white">gray</option>
                                <option id="badge badge-success" value="badge badge-success" class="p-3 mb-2 bg-success text-white">green</option>
                                <option id="badge badge-danger" value="badge badge-danger" class="p-3 mb-2 bg-danger text-white">red</option>
                                <option id="badge badge-warning" value="badge badge-warning" class="p-3 mb-2 bg-warning text-dark">orgrance</option>
                                <option id="badge badge-info" value="badge badge-info" class="p-3 mb-2 bg-info text-white">cyan</option>
                                <option id="badge badge-light" value="badge badge-light" class="p-3 mb-2 bg-light text-dark">white</option>
                                <option id="badge badge-dark" value="badge badge-dark" class="p-3 mb-2 bg-dark text-white">black</option>
                            </select>
                            <span id="review" class=""></span>
                        </div>
                        <div class="clearfix"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <input type="button" class="close btn-sm btn-warning" name="name" value="Lưu" data-dismiss="modal" data-target="#addPtypeModal" onclick="getStatus()" />
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 3. The Modal LOCATION-->
<div class="modal" id="addLocationModal">
    <div class="modal-dialog modal-dialog-centered" style="width: 600px">
        <div class="modal-content text-white" style="background-color:#808080">
            <div class="modal-header">
                <h6 class="modal-title">Thêm Vị trí dự án</h6>
            </div>
            <div class="modal-body text-white">
                <form>
                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên địa điểm</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="LocationName" name="LocationName" placeholder="Tên địa điểm" required="" value="" />
                    </div>
                    <div class="clearfix"></div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="button" class="close btn-sm btn-warning" name="name" value="Lưu" data-dismiss="modal" data-target="#addLocationModal" onclick="getLocation()" />
            </div>
        </div>
    </div>
</div>

<!-- 4. The Modal OWNER-->
<div class="modal" id="addOwnerModal">
    <div class="modal-dialog modal-dialog-centered" style="width: 600px">
        <div class="modal-content text-white" style="background-color:#808080">
            <div class="modal-header">
                <h6 class="modal-title">Thêm Chủ đầu tư</h6>
            </div>
            <div class="modal-body text-white">
                <form>
                    @* start *@
                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên đầy đủ của CDT</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="OwnerName" name="OwnerName" placeholder="Tên theo Hợp đồng" required="" value="" />
                    </div>
                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên rút gọn</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="ShortName" name="ShortName" placeholder="Tên rút gọn" value="" />
                    </div>
                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Người đại diện</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="KeyPerson" name="KeyPerson" placeholder="Tên người đại diện" value="" />
                    </div>
                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Email người đại diện</lable>
                        <input type="email" class="form-control col-md-7 col-sm-9 col-xs-9" id="Email" name="Email" placeholder="" value="" />
                    </div>

                    <div class="form-group row  text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Vị trí</lable>
                        <select id="OnwerLocation" name="OnwerLocation" class="form-control col-md-7 col-sm-9 col-xs-9">
                            <option value="">Chọn</option>
                            @foreach (var item in locations.Where(s => s.LocationId != 1).OrderBy(s => s.LocationName))
                            {
                                <option value=@item.LocationId>@item.LocationName</option>
                            }
                        </select>
                    </div>

                    <div class="form-group row text-left">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Mô tả</lable>
                        <textarea type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="OnwerDescription" name="OnwerDescription" placeholder="Mô tả ngắn gọn" value=""></textarea>
                    </div>

                    @* End *@
                    <div class="clearfix"></div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="button" class="close btn-sm btn-warning" name="name" value="Lưu" data-dismiss="modal" data-target="#addOwnerModal" onclick="getOwner()" />
            </div>
        </div>
    </div>
</div>

<!-- 5. The Modal STAGE-->
<div class="modal" id="addStageModal">
    <div class="modal-dialog modal-dialog-centered" style="width: 600px">
        <div class="modal-content text-white" style="background-color:#808080">
            <div class="modal-header">
                <h6 class="modal-title">Thêm Giai đoạn</h6>
            </div>
            <div class="modal-body text-white">
                <form>
                    <div class="form-group row text-left text-dark">
                        <lable class="control-label col-md-3 col-sm-3 col-xs-3">Tên Giai đoạn</lable>
                        <input type="text" class="form-control col-md-7 col-sm-9 col-xs-9" id="StageName" name="StageName" placeholder="Tên giai đoạn" required="" value="" />
                    </div>
                    <div class="clearfix"></div>
                </form>
            </div>
            <div class="modal-footer">
                <input type="button" class="close btn-sm btn-warning" name="name" value="Lưu" data-dismiss="modal" data-target="#addStageModal" onclick="getStage()" />
            </div>
        </div>
    </div>
</div>


@* End Form nhập liệu *@


<div class="clearfix"></div>
<div class="col-md-12">
    <div class="col-md-10"></div>
    <div class="col-md-2">
        <button type="button" class="btn btn-dark btn-small text-right" data-toggle="modal" data-target="#newProject"><i class="fa fa-plus-circle"></i> Thêm dự án </button>
    </div>
</div>


@* KHỐI FUNCTIONS THỰC HIỆN GHI NHANH DATA VÀ ĐIỀU CHỈNH NỘI DUNG CONTROLERS *@
<script>
    //PROJECT TYPES
    function getProjectType() {
        const typeName = document.getElementById("typename").value;
        const typedesc = document.getElementById("typedesc").value;
        //lưu Thông tin về Server
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/Project/SaveProjectType',
            data: { TypeName: typeName, Description: typedesc },
            success: function myfunction() {
                alert("Lưu thành công");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });
        //lấy thông tin mới nhất từ server và gán vào Selector
        $.get("/Project/GetProjectTypes", function (data, status) {
            var _returnType = Array.from(data);//Convert data từ server lên
            const selectorPtype = document.getElementById("slprojectType"); // lấy Selector
            selectorPtype.innerHTML = makeOption(_returnType); // gán value trong từng item
            alert("Đã load dữ liệu và gán Loại hình dự án " + status); // thông báo
        });
    }

    //STATUS
    function getStatus() {
        const StatusName = document.getElementById("StatusName").value;
        const ColorCode = document.getElementById("ColorCode").value;
        const selector = document.getElementById("statusId"); // lấy Selector
        //lưu Thông tin về Server
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/Project/SaveProjectStatus',
            data: { StatusName: StatusName, ColorCode: ColorCode },
            success: function myfunction() {
                alert("Lưu thành công");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });
        //lấy thông tin mới nhất từ server và gán vào Selector
        $.get("/Project/GetStatus", function (data, status) {
            //var _returnType = Array.from(data);//Convert data từ server lên
            var content = '';
            for (var i = 0; i < data.length; i++) {
                content += "<option value='" + data[i]?.Id + "'>" + data[i]?.StatusName + "</option>";
            }
            selector.innerHTML = content; // gán value trong từng item
            alert("Đã load dữ liệu và gán tình trạng dự án " + status); // thông báo
        });
    }

    //THAY ĐỔI MÀU SẮC TRẠNG THÁI DỰ ÁN
    function OnchangeColor() {
        var opt = document.getElementById("ColorCode").value;
        //alert(opt);
        document.getElementById("review").setAttribute('class', opt);
        document.getElementById("review").innerText = 'Review Selected color';

    }

    //LOCATIONS
    function getLocation() {
        const LocationName = document.getElementById("LocationName").value;
        const selector = document.getElementById("locationId"); // lấy Selector

        //lưu Thông tin về Server
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/Project/SaveProjectLocation',
            data: { LocationName: LocationName },
            success: function myfunction() {
                alert("Lưu thành công");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });

        //lấy thông tin mới nhất từ server và gán vào Selector
        $.get("/Project/GetLocations", function (data, status) {
            //var _returnType = Array.from(data);//Convert data từ server lên
            var content = '';
            for (var i = 0; i < data.length; i++) {
                content += "<option value='" + data[i]?.LocationId + "'>" + data[i]?.LocationName + "</option>";
            }
            selector.innerHTML = content; // gán value trong từng item
            alert("Đã load dữ liệu và gán tình trạng dự án " + status); // thông báo
        });
    }

    //OWNERS
    function getOwner() {
        const OwnerName = document.getElementById("OwnerName").value;
        const ShortName = document.getElementById("ShortName").value;
        const KeyPerson = document.getElementById("KeyPerson").value;
        const Email = document.getElementById("Email").value;
        const OnwerLocation = document.getElementById("OnwerLocation").value;
        const OnwerDescription = document.getElementById("OnwerDescription").value;

        const selector = document.getElementById("OwnerId"); // lấy Selector

        //lưu Thông tin về Server
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/Project/SaveProjectOwner',
            data: { OwnerName: OwnerName, ShortName: ShortName, KeyPerson: KeyPerson, Email: Email, OnwerLocation: OnwerLocation, OnwerDescription: OnwerDescription },
            success: function myfunction() {
                alert("Lưu thành công");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });

        //lấy thông tin mới nhất từ server và gán vào Selector
        $.get("/Project/GetOwners", function (data, status) {
            var content = '';
            for (var i = 0; i < data.length; i++) {
                content += "<option value='" + data[i]?.OnwerId + "'>" + data[i]?.ShortName + "</option>";
            }
            selector.innerHTML = content; // gán value trong từng item
            alert("Đã load dữ liệu và gán tình trạng dự án " + status); // thông báo
        });
    }


    //STAGES
    function getStage() {
        const StageName = document.getElementById("StageName").value;
        const selector = document.getElementById("ProjectStage"); // lấy Selector

        //lưu Thông tin về Server
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/Project/SaveProjectState',
            data: { StageName: StageName },
            success: function myfunction() {
                alert("Lưu thành công");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });

        //lấy thông tin mới nhất từ server và gán vào Selector
        $.get("/Project/GetStates", function (data, status) {
            //var _returnType = Array.from(data);//Convert data từ server lên
            var content = '';
            for (var i = 0; i < data.length; i++) {
                content += "<option value='" + data[i]?.Id + "'>" + data[i]?.StageName + "</option>";
            }
            selector.innerHTML = content; // gán value trong từng item
            alert("Đã load dữ liệu và gán tình trạng dự án " + status); // thông báo
        });
    }

</script>



<script>

    function CloseandSave() {
        const typeName = document.getElementById("typename").value;
        const typedesc = document.getElementById("typedesc").value;
        //lưu Thông tin về Server
        $.ajax({
            type: 'POST',
            dataType: 'json',
            url: '/Project/SaveProjectType',
            data: { TypeName: typeName, Description: typedesc },
            success: function myfunction() {
                alert("Lưu thành công");
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
            }
        });
        //lấy thông tin mới nhất từ server và gán vào Selector
        $.get("/Project/GetProjectTypes", function (data, status) {
            var _returnType = Array.from(data);//Convert data từ server lên
            const selectorPtype = document.getElementById("slprojectType"); // lấy Selector
            selectorPtype.innerHTML = makeOption(_returnType); // gán value trong từng item
            alert("Đã load dữ liệu và gán Loại hình dự án " + status); // thông báo
        });
    }

    function makeOption(data) {
        var content = '';
        /*        var _data = Array.from(data);*/
        for (var i = 0; i < data.length; i++) {
            content += "<option value='" + data[i]?.TypeId + "'>" + data[i]?.TypeName + "</option>";
        }
        return content;
    }


</script>


