@model IEnumerable<DMCTimesheet.Models.C03_ProjectMembers>
@{
    DMCTimesheet.Models.C06_UserPermisRelationship Userpermiss = Session["UserPermission"] as DMCTimesheet.Models.C06_UserPermisRelationship;
    DMCTimesheet.Models.C02_Members loginUser = Session["UserLogin"] as DMCTimesheet.Models.C02_Members;

    List<DMCTimesheet.Models.C01_Projects> Projects = ViewBag.Projects as List<DMCTimesheet.Models.C01_Projects>;

    List<DMCTimesheet.Models.C02_Members> _Members = ViewBag.Members as List<DMCTimesheet.Models.C02_Members>;
    List<DMCTimesheet.Models.C02_Members> Members = _Members.OrderBy(s => s.FullName).ToList();
    List<DMCTimesheet.com.cbimtech.MemberServices.MemberOutput> BIMer = new List<DMCTimesheet.com.cbimtech.MemberServices.MemberOutput>();
    if (ViewBag.BIMer != null)
    {
        BIMer = ViewBag.BIMer as List<DMCTimesheet.com.cbimtech.MemberServices.MemberOutput>;
    }

    string Error = Session["MemberAssignError"] as string ?? "";
    //Dự án của từng thành viên
    List<KeyValuePair<int, List<int?>>> ProjectOfMember = new List<KeyValuePair<int, List<int?>>>();
    ProjectOfMember = ViewBag.ProjectOfMember as List<KeyValuePair<int, List<int?>>>;

    List<string> ChartLabels = new List<string>();
    List<double> ChartValue = new List<double>();
    List<DMCTimesheet.Models.C01_Projects> ProjectNeedAssign = new List<DMCTimesheet.Models.C01_Projects>();

    //Java-memberList for selection
    List<string> memberName = new List<string>();
    List<double> memId = new List<double>();
    foreach (var item in Members)
    {
        memberName.Add(item.FullName);
        memId.Add(item.UserID);
    }

    //Image
    string imgPath = "../Assets/Photos/MemberImage/";
    string NoimagePath = "../Assets/Photos/MemberImage/no-image.jpg";

    if (Model != null)
    {
        ProjectNeedAssign.Clear();
        //Danh sách dự án chưa điều phối
        ProjectNeedAssign = Projects.ToList();
        foreach (var item in Model)
        {
            DMCTimesheet.Models.C01_Projects pro = Projects.FirstOrDefault(p => p.ProjectID == item.ProjectID);
            if (pro != null)
            {
                ProjectNeedAssign.Remove(pro);
            }
        }
        //Chart data
        foreach (var item in ProjectOfMember)
        {
            ChartLabels.Add(Members.First(s => s.UserID == item.Key).FullName);
            ChartValue.Add(item.Value.Count());
        }
    }


}
<script src="~/UserStyles/Chart.js/dist/Chart.min.js"></script>
@*<link href="~/Content/cscpda-scrollbar.css" rel="stylesheet" />*@

@* Modal create new Assign *@
<div id="newAM" class="modal fade" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Phân công nhiệm vụ trong dự án</h3>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("NewAM", "Member", FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <form>
                        <div class="form-group row">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3 text-left">Ngày</lable>
                            <input type="date" class="form-control col-sm-7 col-sm-9 col-xs-9" name="Ngay" placeholder="" required="" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        @* ProjectTypeID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-danger">Tên dự án</b></lable>
                            <select required name="ProjectID" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Projects.OrderBy(s => s.ProjectOtherName))
                                {
                                    <option value=@item.ProjectID>@item.ProjectOtherName</option>
                                }
                            </select>
                        </div>
                        @* Chủ trì dự án*@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b>Chủ trì Dự án</b></lable>
                            <select name="ChuTriChinh" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @*Chủ trì bộ môn Kiến trúc *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Chủ trì bộ môn <b class="text-primary">Kiến trúc</b></lable>
                            <select name="ChuTriKienTruc" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 1 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Chủ trì bộ môn Structure ID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Chủ trì bộ môn <b class="text-primary">Kết cấu</b></lable>
                            <select name="ChuTriKetCau" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 2 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Chủ trì bộ môn MEPF *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Chủ trì bộ môn <b class="text-primary">Cơ điện - MEPF</b></lable>
                            <select name="ChuTriMEP" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 3 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Chủ trì bộ môn Legal *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-primary">Pháp lý</b></lable>
                            <select name="LegalManager" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Thành viên khác *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-primary">Thành viên khác</b></lable>
                            <textarea type="text" readonly class="form-control col-sm-7 col-sm-9 col-xs-9" name="ThanhVienKhac" value="" id="Thanhvien_Khac"></textarea>
                        </div>

                        <div class="form-group col-lg-offset-1">
                            <label class="text-lg-center text-primary"><b>Chọn thành viên bổ sung</b></label>
                            <div class="form-group col-md-12">
                                <div class="col-md-3 form-check">

                                    <b class="text-danger">Kiến trúc</b>
                                    <div class="form-check">
                                        @{
                                            int i = 1;
                                            foreach (var item in Members.Where(s => s.Descipline == 1 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                            {
                                                string chkname = string.Concat("chk", i);
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" name="@item.UserID" value="@item.FullName" id="@chkname" onchange="addData(this,'@item.FullName')" />
                                                    <label class="form-check-label" for="@chkname">@item.FullName</label>
                                                </div>
                                                i++;
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="col-md-3 form-check">
                                    <b class="text-danger">Kết cấu</b>
                                    <div class="form-check">
                                        @{
                                            int j = i + 1;
                                            foreach (var item in Members.Where(s => s.Descipline == 2 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                            {
                                                string chkname = string.Concat("chk", j);
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" name="@item.UserID" value="@item.FullName" id="@chkname" onchange="addData(this,'@item.FullName')" />
                                                    <label class="form-check-label" for="@chkname">@item.FullName</label>
                                                </div>
                                                j++;
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="col-md-3 form-check">
                                    <b class="text-danger">MEPF</b>
                                    <div class="form-check">
                                        @{
                                            int k = j + 1;
                                            foreach (var item in Members.Where(s => s.Descipline == 3 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                            {
                                                string chkname = string.Concat("chk", k);
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" name="@item.UserID" value="@item.FullName" id="@chkname" onchange="addData(this,'@item.FullName')" />
                                                    <label class="form-check-label" for="@chkname">@item.FullName</label>
                                                </div>
                                                k++;
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="col-md-3 form-check">
                                    <b class="text-danger">Khác</b>
                                    <div class="form-check">
                                        @{
                                            int l = k + 1;
                                            foreach (var item in Members.Where(s => s.Descipline > 3 && s.SystemMember == false && s.Deactived == false).OrderBy(s => s.UserName))
                                            {
                                                string chkname = string.Concat("chk", l);
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" name="@item.UserID" value="@item.FullName" id="@chkname" onchange="addData(this,'@item.FullName')" />
                                                    <label class="form-check-label" for="@chkname">@item.FullName</label>
                                                </div>
                                                l++;
                                            }
                                        }
                                    </div>
                                </div>
                            </div>

                        </div>


                        <hr />
                        <div class="clearfix"></div>

                        <div class="form-group text-left">
                            <input type="submit" value="Save" class="btn btn-outline-danger" />
                        </div>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

<div><b class="text-danger">@ViewBag.Error</b></div>
@* Form nhập liệu *@
<div id="newAssignMember" class="modal fade" role="dialog">
    <div class="modal-dialog modal-m">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Thêm Thành viên cho dự án mới</h3>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("NewAssignMember", "Member", FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <form>
                        <div class="form-group row">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3 text-left">Ngày</lable>
                            <input type="date" class="form-control col-sm-7 col-sm-9 col-xs-9" name="Ngay" placeholder="" required="" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                        </div>
                        @* ProjectTypeID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-danger">Tên dự án</b></lable>
                            <select required name="ProjectID" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Projects.OrderBy(s => s.ProjectOtherName))
                                {
                                    <option value=@item.ProjectID>@item.ProjectOtherName</option>
                                }
                            </select>
                        </div>
                        @* ARC ID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b>Chủ trì Dự án</b></lable>
                            <select name="ChuTriChinh" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Kiến trúc *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Chủ trì bộ môn <b class="text-primary">Kiến trúc</b></lable>
                            <select name="ChuTriKienTruc" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 1 && s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Kiến trúc 2*@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Hỗ trợ bộ môn <b class="text-primary">Kiến trúc</b></lable>
                            <select name="ChuTriKienTruc2" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 1 && s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Structure ID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Chủ trì bộ môn <b class="text-primary">Kết cấu</b></lable>
                            <select name="ChuTriKetCau" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 2 && s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Structure 2 *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Hỗ trợ bộ môn <b class="text-primary">Kết cấu</b></lable>
                            <select name="ChuTriKetCau2" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 2 && s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>

                        @* MEP ID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Chủ trì bộ môn <b class="text-primary">Cơ điện - MEPF</b></lable>
                            <select name="ChuTriMEP" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 3 && s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* MEP 2 *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Hỗ trợ bộ môn <b class="text-primary">Cơ điện - MEPF</b></lable>
                            <select name="ChuTriMEP2" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.Descipline == 3 && s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Legal ID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-primary">Pháp lý</b></lable>
                            <select name="LegalManager" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* Legal 2 *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-primary">Hỗ trợ Pháp lý</b></lable>
                            <select name="LegalManager2" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3"><b class="text-primary">Admin</b></lable>
                            <select name="Admin" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @foreach (var item in Members.Where(s => s.SystemMember == false).OrderBy(s => s.UserName))
                                {
                                    <option value=@item.UserID>@item.FullName</option>
                                }
                            </select>
                        </div>
                        @* BIM ID *@
                        <div class="form-group row  text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3">Quản lý <b class="text-primary">BIM</b></lable>
                            <select name="BIMManager" class="form-control col-sm-7 col-sm-9 col-xs-9">
                                <option value=""></option>
                                @if (BIMer.Count() > 0)
                                {
                                    foreach (var item in BIMer.Where(s => s.UserType == "User").OrderBy(s => s.SoftName))
                                    {
                                        <option value=@item.ID>@item.SoftName</option>
                                    }
                                }
                                else
                                {
                                    <option value="">Kết nối data BIM lỗi</option>
                                }
                            </select>
                        </div>
                        <br />
                        <div class="clearfix"></div>

                        <div class="form-group text-left">
                            <lable class="control-label col-sm-3 col-sm-3 col-xs-3 text-left"></lable>
                            <input type="submit" value="Save" class="btn btn-success col-sm-7" />
                        </div>
                    </form>
                }
            </div>
        </div>
    </div>
</div>
@* End Form nhập liệu *@
<div class="clearfix"></div>
<h3 class="text-danger"><i>@Error</i></h3>
<div class="clearfix"></div>

@* Tiêu đề danh sách dự án *@
<div class="col-md-12">
    <div class="col-md-7">
        <h3 class="text-left">DANH SÁCH THÀNH VIÊN THEO DỰ ÁN</h3>
    </div>
    <div class="col-md-5 text-right inline">
        <button type="button" class="btn btn-warning btn-outline-dark btn-small text-right" data-toggle="modal" data-target="#newAM"><i class="fa fa-plus"></i> Phân công nhiệm vụ</button>
        @*<button type="button" onclick="alert('Tính năng đang tích hợp!')" class="btn btn-warning btn-outline-dark btn-small text-right" data-toggle="modal" data-target="#newProject"><i class="fa fa-home"></i>Thêm dự án</button>*@
       
    <button type="button" onclick="loadPartialView()" class="btn btn-warning btn-outline-dark btn-small text-right" data-toggle="modal" data-target="#newProject">more...<i class="fa fa-fighter-jet"></i> </button>
    
    </div>

</div>

@* PartialView *@
<div id="partialViewContainer"></div>


<div class="clearfix"></div>
@* bảng thống kê dự án *@
<div>
    <table class="table">
        <thead class="table-dark">
            <tr class="row text-center">
                <td class="col-md-1"><b>Ngày lập</b></td>
                <td class="col-md-2"><b>Dự án</b></td>
                <td class="col-md-1"><b>Chủ trì dự án</b></td>
                <td class="col-md-1"><b>Bộ môn Kiến trúc</b></td>
                <td class="col-md-1"><b>Bộ môn Kết cấu</b></td>
                <td class="col-md-1"><b>Bộ môn MEP</b></td>
                <td class="col-md-1"><b>Pháp lý dự án</b></td>
                <td class="col-md-3"><b>Thành viên khác</b></td>
                @*<td class="col-1"><b>Quản lý BIM</b></td>*@
                <td class="col-md-1"><b>Xóa</b></td>
            </tr>
        </thead>
    </table>
</div>
@*  *@
<div class="table-responsive " style="height:600px">
    <table class="table table-hover table-bordered table-striped">
        <caption>Số lượng dự án <b class="text-danger">@Model.Count()</b></caption>
        <tbody>
            @if (Model == null || Model.Count() == 0)
            {
                <tr class="row">
                    <td>Chưa chỉ định Nhân sự cho dự án</td>
                </tr>
            }
            else
            {
                foreach (var item in Model.OrderByDescending(s => s.ProjectID))
                {
                    string name = @Projects.FirstOrDefault(s => s.ProjectID == item.ProjectID).MaDuAn + "-" + @Projects.FirstOrDefault(s => s.ProjectID == item.ProjectID).ProjectOtherName;

                    <tr class="row text-dark text-center">
                        <td class="col-md-1">@DateTime.Parse(item.Ngay.ToString()).ToShortDateString()</td>
                        <td class="col-md-2 text-left"><b>@Html.ActionLink(name, "EditAssign", "Member", new { Id = item.ID }, new { @class = "text-primary" })</b></td>
                        @* Chủ trì Chính *@
                        <td class="col-md-1">
                            @if (item.ChuTriChinh != null)
                            {
                                if (@Members.FirstOrDefault(s => s.UserID == item.ChuTriChinh).Deactived == true)
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriChinh).FullName <i class="text-danger">*</i></b>
                                }
                                else
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriChinh).FullName</b>
                                }
                            }
                        </td>
                        @* Chủ trì Kiến trúc *@
                        <td class="col-md-1 text-left text-justify">

                            @if (item.ChuTriKienTruc != null)
                            {
                                if (@Members.FirstOrDefault(s => s.UserID == item.ChuTriKienTruc).Deactived == true)
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriKienTruc).FullName <i class="text-danger">*</i></b>
                                }
                                else
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriKienTruc).FullName</b>
                                }
                                @*<b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriKienTruc).FullName </b>*@
                            }
                        </td>
                        @* Chủ trì Kết cấu *@
                        <td class="col-md-1 text-sm-left">
                            @if (item.ChuTriKetCau != null)
                            {
                                if (@Members.FirstOrDefault(s => s.UserID == item.ChuTriKetCau).Deactived == true)
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriKetCau).FullName <i class="text-danger">*</i></b>
                                }
                                else
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriKetCau).FullName</b>
                                }
                                @*<b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriKetCau).FullName</b>*@
                            }

                        </td>
                        @* Chủ trì MEPF *@
                        <td class="col-md-1 text-sm-left">

                            @if (item.ChuTriMEP != null)
                            {
                                if (@Members.FirstOrDefault(s => s.UserID == item.ChuTriMEP).Deactived == true)
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriMEP).FullName <i class="text-danger">*</i></b>
                                }
                                else
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriMEP).FullName</b>
                                }
                                @*<b class="">@Members.FirstOrDefault(s => s.UserID == item.ChuTriMEP).FullName</b>*@
                            }

                        </td>
                        @* Pháp Lý dự án *@
                        <td class="col-md-1 text-sm-left">
                            @if (item.LegalManager != null)
                            {
                                if (@Members.FirstOrDefault(s => s.UserID == item.LegalManager).Deactived == true)
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.LegalManager).FullName <i class="text-danger">*</i></b>
                                }
                                else
                                {
                                    <b class="">@Members.FirstOrDefault(s => s.UserID == item.LegalManager).FullName</b>
                                }
                                @*<b class=""> @Members.FirstOrDefault(s => s.UserID == item.LegalManager).FullName</b>*@
                            }

                        </td>
                        @* Thành viên khác *@
                        <td class="col-md-3 text-sm-left">
                            <ul class="col">
                                @if (!string.IsNullOrEmpty(item.ThanhVienKhac))
                                {
                                    foreach (var itm in item.ThanhVienKhac.Split(',').ToList().Where(s=> s != null).ToArray())
                                    {
                                        int uId = int.Parse(itm);
                                        
                                        string fullname = "Chua xac dinh";
                                        try
                                        {
                                            if (@Members.FirstOrDefault(s => s.UserID == uId).Deactived == true)
                                            {
                                                fullname = @_Members.FirstOrDefault(s => s.UserID == uId).FullName + "*";
                                            }
                                            else
                                            {
                                                fullname = @_Members.FirstOrDefault(s => s.UserID == uId).FullName;
                                            }
                                            //fullname = @_Members.FirstOrDefault(s => s.UserID == uId).FullName;
                                        }
                                        catch (Exception ex)
                                        {
                                            fullname = $"Chua xac dinh do {ex.Message}";
                                        }
                                        <li class="col-sm-6 text-left">@fullname</li>
                                    }
                                }
                            </ul>

                        </td>

                        @*<td class="col-1 text-sm-left">
                                @if (item.BIMManager != null)
                                {
                                    if (BIMer.Count() > 0)
                                    {
                                        <b> @BIMer.FirstOrDefault(s => s.ID == item.BIMManager).SoftName</b>
                                    }

                                }
                            </td>*@
                        <td class="col-md-1">@Html.ActionLink(" ", "DeleteAssigned", "Member", new { ID = item.ID }, new { @class = "btn fa fa-remove" })</td>
                    </tr>
                }
            }

        </tbody>
    </table>
</div>

<p class="text-danger"><i>[*] là nhân sự đã chuyển công tác</i></p>
<div>
    <b>Danh sách dự án chưa điều phối</b>
    <ul class="col">
        @foreach (var item in ProjectNeedAssign.Distinct())
        {
            <li class="col-sm-2 text-primary"><b>@item.ProjectOtherName</b></li>
        }
    </ul>
</div>
<div class="clearfix"></div>
<hr />
<h3 class="text-center text-primary">CÔNG VIỆC ĐƯỢC GIAO</h3>
<div>
    @* Bảng thống kê *@
    <div class="col-sm-6">
        <h5 class="text-center">Bảng thống kê số lượng dự án theo thành viên</h5>
        <table class="table table-bordered table-condensed table-striped">
            <tr class="text-white" style="background-color:#808080">
                <td class="col-sm-3">Tên thành viên</td>
                @*<td class="col-sm-2">SL dự án</td>*@
                <td class="col-sm-9">Tên dự án</td>
            </tr>
        </table>
        <div class="table-responsive" style="height:600px">
            <table class="table table-bordered table-condensed table-striped">
                <tbody class="table">
                    @if (Model == null || Model.Count() == 0)
                    {
                        <tr class="row">
                            <td>Chưa có thông tin</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in ProjectOfMember.OrderByDescending(s => s.Value.Count()))
                        {
                            if (item.Value.Count() != 0)
                            {
                                string UserImg = "";
                                if (Members.FirstOrDefault(s => s.UserID == item.Key).Image == null)
                                {
                                    UserImg = NoimagePath;
                                }
                                else
                                {
                                    UserImg = imgPath + @Members.FirstOrDefault(s => s.UserID == item.Key).Image;
                                }
                                <tr class="text-dark text-center row">
                                    <td class="col-sm-3 text-center">
                                        <p>
                                            <img src="@UserImg" class="img-circle" alt="Alternate Text" style="height:50px; width:50px" />
                                        </p>
                                        <p>
                                            <b>@Members.FirstOrDefault(s => s.UserID == item.Key).FullName</b>
                                        </p>
                                        <p class="inline">
                                            <h4 class="text-primary">@item.Value.Count()<small> dự án</small></h4>
                                        </p>
                                    </td>
                                    @* <td class="col-sm-2">@item.Value.Count()</td>*@
                                    <td class="col-sm-9">
                                        <ol class="col">
                                            @foreach (var itm in item.Value.ToList())
                                            {
                                                <li class="col-sm-6 text-left"><b>@Projects.FirstOrDefault(s => s.ProjectID == itm).ProjectOtherName</b></li>

                                            }
                                        </ol>

                                    </td>
                                </tr>
                            }

                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    @* Biểu đồ dự án theo nhân sự *@
    <div class="col-sm-6">
        <h5 class="text-center">Biểu đồ số lượng dự án theo thành viên</h5>
        <div>
            <canvas id="ProjectOfMemberSummary"></canvas>
        </div>
    </div>
</div>

<script>
    function getDMCmember() {
        $('#createBtn').click(function () {
            var selectedItems = [];
            var Thanhvien_Khac = document.getElementById("Thanhvien_Khac");
            Thanhvien_Khac.value = "";
            // Process the selectedItems array as needed (e.g., save to a database, etc.)
            var selectedItems = [];
            $('.form-check-input:checked').each(function () {
                selectedItems.push($(this).val());
            });
            Thanhvien_Khac.value = selectedItems;

        });
    }


    function addData(checkbox, userName) {
        if (checkbox.checked) {
            //document.getElementById("Thanhvien_Khac").value += targetName + ";";
            document.getElementById("Thanhvien_Khac").value += userName + ",";
        }
        else if (!checkbox.checked) {
            //var targets = [];
            //targets = document.getElementById("Thanhvien_Khac").value.split(';');
            targets = document.getElementById("Thanhvien_Khac").value.split(',');
            var newmemberlist = [];
            $('.form-check-input:checked').each(function () {
                newmemberlist.push($(this).val());
            });
            alert("Removed: '" + userName + " !'");
            document.getElementById("Thanhvien_Khac").value = newmemberlist + ',';
            if (document.getElementById("Thanhvien_Khac").value == "NaN") {
                alert("Project don't have any member !");
                document.getElementById("Thanhvien_Khac").value = "";
            }
        }
    }


</script>


@* Load PartialView *@
<script type="text/javascript">
    function loadPartialView() {
        $.ajax({
            url: "@Url.Action("AddProjectPartialView", "Member")",
            type: "GET",
            success: function (response) {
                $("#partialViewContainer").html(response);
            }
        });
    }
</script>        


@section Scripts {
    <script>
        $(document).ready(function () {
            function searchFailed() {
                $("#searchResult").html("Không thấy dữ liệu.");
            }
        });
    </script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
}

@* Chart code *@
<script>
    var ctx = document.getElementById('ProjectOfMemberSummary').getContext('2d');
    var lable = @Html.Raw(Json.Encode(ChartLabels));
    var data =@Html.Raw(Json.Encode(ChartValue));
   var myChart = new Chart(ctx, {
       type: 'bar',
                        data: {
                        labels:  lable,
                            datasets: [{
                                label: '',
                                data: data,
                                backgroundColor: 'rgba(64, 64, 64, 0.3)',
                                borderColor:'rgba(0, 0, 0, 1)',
                                borderWidth: 1
                            }]
                        },
       options: {
           scales: {
               yAxes: [{
                   ticks: {
                       beginAtZero: true
                       /*lables: lablesVlue, type: 'category',*/
                   }
               }]
           },
           showToolTips: true,
           legend: { display: false },
           animation:
           {
               duration: 0,
               onComplete: function () {
                   var ctx = this.chart.ctx;
                   ctx.font = Chart.helpers.fontString(Chart.defaults.global.defaultFontSize, 'normal', Chart.defaults.global.defaultFontFamily);
                   ctx.fillStyle = this.chart.config.options.defaultFontColor;
                   ctx.textAlign = 'top';
                   ctx.textBaseline = 'top';
                   this.data.datasets.forEach(function (dataset) {
                       for (var i = 0; i < dataset.data.length; i++) {
                           var model = dataset._meta[Object.keys(dataset._meta)[0]].data[i]._model;
                           ctx.fillText(dataset.data[i], model.x, model.y - 5);
                       }
                   });
               }
           }
       }
                    });
</script>

<style>
    .oneline {
        /*width: 400px;*/
        overflow: auto;
        white-space: nowrap;
        /*text-overflow:clip;*/
    }
</style>